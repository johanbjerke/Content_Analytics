<form script="dashboard.js" stylesheet="dashboard.css" theme="light">
  <label>Cyber Kill Chain</label>
  <init>
    <set token="chart_post_process">| append
[
| inputlookup kill_chain_phases.csv
| fields title order_title
| rename order_title AS "Kill Chain Phase"
]
| stats first(*) AS * BY "Kill Chain Phase"
| fields - "Kill Chain Phase"
| rename title AS "Kill Chain Phase"
| fillnull
|  foreach "Current" "Phase 1 - Potential" "Phase 2 - Needs more data" Selected
[
    | eval "&lt;&lt;FIELD&gt;&gt;"=if(isnull('&lt;&lt;FIELD&gt;&gt;'), 0,'&lt;&lt;FIELD&gt;&gt;' )
]
| table "Kill Chain Phase" "Current" "Phase 1 - Potential" "Phase 2 - Needs more data" Selected</set>
    <set token="addsample"></set>
    <set token="replacewithsample"></set>
    <set token="y_field">Status</set>
  </init>
  <search>
    <query>| rest splunk_server=local /services/apps/local | search disabled=0 title=*sankey*</query>
    <done>
      <condition match="'job.resultCount' == 0">
        <set token="nosankey">nosankey</set>
        <unset token="sankey">sankey</unset>
      </condition>
      <condition match="'job.resultCount' &gt; 0">
        <unset token="nosankey">nosankey</unset>
        <set token="sankey">sankey</set>
      </condition>
    </done>
  </search>
  <search>
    <query>| rest splunk_server=local /services/apps/local | search disabled=0 title=*radar*</query>
    <done>
      <condition match="'job.resultCount' == 0">
        <set token="noradar">noradar</set>
        <unset token="radar">radar</unset>
      </condition>
      <condition match="'job.resultCount' &gt; 0">
        <unset token="noradar">noradar</unset>
        <set token="radar">radar</set>
      </condition>
    </done>
  </search>
  <search id="usecase_base">
    <query>
| rest splunk_server=local count=0 /services/saved/searches search=action.correlationsearch.enabled
| rename eai:acl.app as app, title as csearch_name, action.correlationsearch.label as csearch_label, action.notable.param.security_domain as security_domain, action.escu.providing_technologies AS providing_technologies, action.escu.analytic_story AS analytic_story
| append [ `getsse` ]
| rex field=qualifiedSearch ".*datamodel(=\"|:\"|\(\"|\s|:|=)(\"|)(?&lt;datamodel&gt;[a-z,A-Z,_]*)"
| lookup Datamodel_Event_Summary.csv datamodel
| eval csearch_label=coalesce(csearch_label,csearch_name)
| fillnull EventCount Hosts
| fields action.escu.mappings analytic_story csearch_label description qualifiedSearch datamodel EventCount Hosts disabled app displayapp security_domain providing_technologies usecase hasSearch includeSSE datasource displayapp app journey category domain icon description dashboard mitre killchain alertvolume bookmark_status
| where len(description)&gt;0

| spath input="analytic_story" path="{}" output="analytic_story"
| eval deeplink=case(
isnotnull(analytic_story),"DA-ESS-ContentUpdate/analytic_story_details?form.analytic_story_name=".replace(mvindex(analytic_story,0), "\s", "%20"),
isnotnull(dashboard),"Splunk_Security_Essentials/".replace(dashboard, "\s", "%20"),
1=1,"SplunkEnterpriseSecuritySuite/ess_content_management?textFilter=".replace(csearch_label, "\s", "%20")
)

| spath input="action.escu.mappings" path=cis20{} output="CIS"
| spath input="action.escu.mappings" path=mitre_attack{} output="MITRE Attack Technique"
| spath input="action.escu.mappings" path=kill_chain_phases{} output="Kill Chain Phase"
| eval "MITRE Attack Technique"=coalesce('MITRE Attack Technique', mitre)
| lookup kill_chain_phases title AS "Kill Chain Phase" OUTPUT order_title AS kill_chain_phase_order_title
| eval "Kill Chain Phase Orig"='Kill Chain Phase'
| eval "Kill Chain Phase"=kill_chain_phase_order_title

| where isnotnull('Kill Chain Phase')

| rex max_match=0 field="qualifiedSearch" "sourcetype(=\"|=)(?&lt;Sourcetype&gt;[^\s^\"^\)]*)"
| lookup SourcetypeNormalisation Sourcetype OUTPUT Normalised
| rex max_match=0 field="qualifiedSearch" "source(=\"|=)(?&lt;Source&gt;[^\s^\"^\)]*)"
| lookup SourceToSourcetype Source OUTPUT Sourcetype AS SourcetypeFromSource
| eval Sourcetype=mvdedup(coalesce(Normalised,SourcetypeFromSource,Sourcetype))
| eval sourcetype_origin="from_use_case"
| lookup Installed_sourcetypes.csv Sourcetype OUTPUT sourcetype_origin AS sourcetype_origin2, app AS AddOn
| lookup Sample_sourcetypes.csv Sourcetype OUTPUT sourcetype_origin AS sourcetype_origin_sample, app AS AddOn_sample
| eval sourcetype_origin=coalesce(sourcetype_origin2,sourcetype_origin)
| fields - sourcetype_origin2

| eval providing_technologies=split(providing_technologies, ",")
| rex field=providing_technologies mode=sed "s/[\"\[\]]//g"
| eval providing_technologies=trim(providing_technologies)

| rename csearch_label AS "Title", description AS Description, qualifiedSearch as "Detection Search", datamodel AS Datamodel, EventCount AS Events, providing_technologies AS "Providing Technologies"
| eval Enabled=if(disabled=1, "No", "Yes")
| eval App=case(app="DA-ESS-ContentUpdate", "ES Content Updates", like(app,"SplunkEnterpriseSecuritySuite") OR  like(app,"SA-%") OR like(app,"DA-%"), "Enterprise Security", like(Description,"%Security Essentials%"), "Splunk Security Essentials",isnotnull(displayapp),displayapp,1=1, app)
| join type=outer Datamodel 
    [| rest splunk_server=local count=0 /servicesNS/-/-/admin/datamodel-files 
    | spath input=eai:data output=base_search path=objects{}.baseSearch 
    | spath input=eai:data output=constraints path=objects{}.constraints{}.search 
    | eval tag_content = mvappend(base_search,constraints) 
    | rex max_match=0 field=tag_content "tag=\"?(?&lt;tag_name&gt;\w+)\"?" 
    | mvexpand tag_name 
    | rename title AS datamodel 
    | fields tag_name datamodel 
    | append 
        [| rest splunk_server=local count=0 /servicesNS/-/-/admin/eventtypes 
        | rename eai:acl.app AS app tags AS tag_name 
        | search app="*TA*" 
        | rex max_match=0 field=search "sourcetype=\"?(?&lt;sourcetype&gt;[^\s\"^)]+)\"?" 
        | mvexpand sourcetype 
        | lookup SourcetypeNormalisation Sourcetype AS sourcetype OUTPUT Normalised
        | eval sourcetype=mvdedup(coalesce(Normalised,sourcetype))
        | mvexpand sourcetype 
        | mvexpand tag_name 
        | eval app_sourcetype=mvzip(app,sourcetype,"__") 
        | fields sourcetype tag_name app_sourcetype app 
        | stats values(tag_name) as tag_name by app, sourcetype,app_sourcetype
        | eval c="Manually exclude perfmon and certain WMI as it is mostly not valuable for security and it clogs up the stats"
        | fields - c
        | where NOT (like(lower(sourcetype),"%perfmon%") OR ( like(lower(sourcetype),"wmi:%") AND NOT like(lower(sourcetype),"wmi:wineventlog:security") ) )
            ] 
    $addsample$
    | stats first(Hosts) AS Hosts,sum(EventCount) AS "EventCount",first(totalCount) AS totalCount,list(datamodel) as datamodel, list(app) as app, list(app_sourcetype) as app_sourcetype by tag_name 
    | search datamodel=* 
    | eval datamodel=mvdedup(datamodel) 
    | stats first(Hosts) AS Hosts,values(EventCount) AS "EventCount",values(app_sourcetype) as app_sourcetype, values(tag_name) as tags by datamodel 
    | rex max_match=0 field=app_sourcetype "\"?(?&lt;app&gt;.+)__\"?" 
    | rex max_match=0 field=app_sourcetype "__\"?(?&lt;sourcetype&gt;.+)\"?" 
    | eval tags=mvdedup(tags),app=mvdedup(app),EventCount=mvdedup(EventCount) 
    | eventstats sum(EventCount) AS EventCount BY datamodel 
    | fields - app_sourcetype 
    | lookup Datamodel_Event_Summary.csv datamodel
    | rename datamodel AS Datamodel, tags as Tags, sourcetype AS Sourcetype, app AS AddOn
    | lookup Installed_sourcetypes.csv Sourcetype OUTPUT sourcetype_origin AS sourcetype_origin
    | lookup Sample_sourcetypes.csv Sourcetype OUTPUT sourcetype_origin AS sourcetype_origin_sample, app AS AddOn_sample 
    | fillnull Hosts 
    | eval Acceleration=round(Acceleration,2)
        ]
$replacewithsample$
| eval Datamodel=coalesce(Datamodel,"-")
| eval AddOn=coalesce(split(replace(AddOn,"\n","---"),"---"),AddOn,"-"),Sourcetype=coalesce(split(replace(Sourcetype,"\n","---"),"---"),Sourcetype,"-"),sourcetype_origin=coalesce(split(replace(sourcetype_origin,"\n","---"),"---"),sourcetype_origin,"-")
| lookup Installed_sourcetypes.csv Sourcetype OUTPUT sourcetype_count_24h host_count_24h
| rename sourcetype_count_24h AS "EventCount (Sourcetype)",host_count_24h AS "HostCount (Sourcetype)"
| eval Accelerated=if(Acceleration&gt;0, "Yes","No")
| eval "Enabled and Accelerated"=if(Acceleration&gt;0 AND Enabled="Yes", "Yes","No")
| eval "Has Data (DM)"=if(EventCount&gt;0, "Yes", "No")
| eval "Has Data (Index)"=if('EventCount (Sourcetype)'&gt;0, "Yes", "No")
| eval Status=case(
'Enabled'="Yes" AND ('Has Data (DM)'="Yes" OR 'Has Data (Index)'="Yes"),"Current",
('Has Data (DM)'="Yes" OR 'Has Data (Index)'="Yes"),"Phase 1 - Potential",
1=1,"Phase 2 - Needs more data"
)

| eval "Detection Type"=if(Datamodel!="-", "Datamodel", "Index")
| eventstats dc(eval(if(Sourcetype="-",null,Sourcetype))) AS "Sourcetypes Installed Count",dc(eval(if(AddOn="-",null,AddOn))) AS "AddOns Installed Count" BY "Title"
| eval Details="Detection Enabled: ".Enabled
| eval Details=mvappend(Details, "Detection Type: ".'Detection Type')
| eval Details=if('Detection Type'="Datamodel",mvappend(Details, "Datamodel accelerated: ".if(coalesce('Acceleration',0)&gt;0,"Yes","No")),Details)
| eval Details=if('Detection Type'="Datamodel",mvappend(Details, "Datamodel has data (-24h): ".'Has Data (DM)'),Details)
| eval Details=if('Detection Type'="Datamodel",mvappend(Details, "Hosts with data (-24h): ".'Hosts'),Details)
| eval Details=if('Detection Type'="Index",mvappend(Details, "Indexed data exists (-24h): ".'Has Data (Index)'),Details)
| eval Details=if('Detection Type'="Index",mvappend(Details, "Hosts with data (-24h): ".'HostCount (Sourcetype)'),Details)
| eval Details=mvappend(Details, "Sourcetypes Installed: ".'Sourcetypes Installed Count')
| eval Details=mvappend(Details, "Add-Ons Installed: ".'AddOns Installed Count')
| eval Hosts=if('Detection Type'="Index",'HostCount (Sourcetype)',Hosts)

</query>
  </search>
  <fieldset submitButton="false"></fieldset>
  <row>
    <panel>
      <html>
        Each number represents a piece of content<br/>
  For more details check the <a href="https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html" target="_blank">Cyber Kill Chain</a>
  
      </html>
    </panel>
  </row>
  <row id="cs2">
    <panel>
      <single>
        <title>Current</title>
        <search base="usecase_base">
          <query>| where Status="Current"
| stats count</query>
        </search>
        <option name="colorMode">block</option>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0x638771","0x3c444d"]</option>
        <option name="rangeValues">[1000]</option>
        <option name="refresh.display">progressbar</option>
        <option name="underLabel">Content (Enabled)</option>
        <option name="useColors">1</option>
        <drilldown>
          <set token="form.corr_enabled">Yes</set>
          <set token="form.corr_data">=*</set>
          <set token="form.phase">Current</set>
        </drilldown>
      </single>
    </panel>
    <panel>
      <single>
        <title>Phase 1 - Potential</title>
        <search base="usecase_base">
          <query>| where Status="Phase 1 - Potential"
| stats count</query>
        </search>
        <option name="colorMode">block</option>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0xA0BBAA","0x3c444d"]</option>
        <option name="rangeValues">[1000]</option>
        <option name="refresh.display">progressbar</option>
        <option name="underLabel">Content (Data Exist)</option>
        <option name="useColors">1</option>
        <drilldown>
          <set token="form.corr_enabled">No</set>
          <set token="form.corr_data">&gt;0</set>
          <set token="form.phase">Phase 1 - Potential</set>
        </drilldown>
      </single>
    </panel>
    <panel>
      <single>
        <title>Phase 2 - Needs more data</title>
        <search base="usecase_base">
          <query>| where Status="Phase 2 - Needs more data"
| stats count</query>
        </search>
        <option name="colorMode">block</option>
        <option name="drilldown">all</option>
        <option name="rangeColors">["0xE0E9E3","0x3c444d"]</option>
        <option name="rangeValues">[10000]</option>
        <option name="refresh.display">progressbar</option>
        <option name="underLabel">Content (Total)</option>
        <option name="useColors">1</option>
        <drilldown>
          <set token="form.corr_enabled">*</set>
          <set token="form.corr_data">=*</set>
          <set token="form.phase">Phase 2 - Needs more data</set>
        </drilldown>
      </single>
    </panel>
  </row>
  <row id="tabs">
    <panel>
      <html>
      <h1>Content Overview - Click to filter</h1>
      <ul id="tabs" class="nav nav-tabs">
                    <li class="active">
                        <a href="#" class="toggle-tab" data-toggle="tab" data-elements="row1_col1,row4_col1" data-token="row1_col1">Chart View</a>
                    </li>
                    <li>
                        <a href="#" class="toggle-tab" data-toggle="tab" data-elements="row2_col1,row4_col1" data-token="row2_col1">Radar View</a>
                    </li>
                    <li>
                        <a href="#" class="toggle-tab" data-toggle="tab" data-elements="row3_col1,row4_col1" data-token="row3_col1">Sankey View</a>
                    </li>
				</ul>
				
				
    </html>
    </panel>
  </row>
  <row id="row1_col1">
    <panel>
      <input type="dropdown" token="x_field">
        <label>Split by</label>
        <choice value="Datamodel">Datamodel</choice>
        <choice value="AddOn">Add-On</choice>
        <choice value="App">App</choice>
        <choice value="Sourcetype">Sourcetype</choice>
        <choice value="Kill Chain Phase">Kill Chain Phase</choice>
        <default>Kill Chain Phase</default>
        <change>
          <condition label="Kill Chain Phase">
            <set token="chart_post_process">| append
[
| inputlookup kill_chain_phases.csv
| fields title order_title
| rename order_title AS "Kill Chain Phase"
]
| stats first(*) AS * BY "Kill Chain Phase"
| fields - "Kill Chain Phase"
| rename title AS "Kill Chain Phase"
| fillnull
|  foreach "Current" "Phase 1 - Potential" "Phase 2 - Needs more data" Selected
[
    | eval "&lt;&lt;FIELD&gt;&gt;"=if(isnull('&lt;&lt;FIELD&gt;&gt;'), 0,'&lt;&lt;FIELD&gt;&gt;' )
]
| table "$x_field$" "Current" "Phase 1 - Potential" "Phase 2 - Needs more data" Selected</set>
          </condition>
          <condition label="*">
            <set token="chart_post_process">|  foreach "Current" "Phase 1 - Potential" "Phase 2 - Needs more data"
[
    | eval "&lt;&lt;FIELD&gt;&gt;"=if(isnull('&lt;&lt;FIELD&gt;&gt;'), 0,'&lt;&lt;FIELD&gt;&gt;' )
]
| table "$x_field$" "Current" "Phase 1 - Potential" "Phase 2 - Needs more data"</set>
          </condition>
        </change>
      </input>
      <input type="dropdown" token="phase">
        <label>Phase</label>
        <choice value="*">Any</choice>
        <choice value="Current">Current</choice>
        <choice value="Phase 1 - Potential">Phase 1</choice>
        <choice value="Phase 2 - Needs more data">Phase 2</choice>
        <default>*</default>
      </input>
      <input type="dropdown" token="sourcetype_origin">
        <label>Sourcetype origin</label>
        <choice value="installed">Installed Sourcetypes</choice>
        <choice value="sample">Sample Sourcetypes</choice>
        <choice value="*">All Sourcetypes</choice>
        <default>installed</default>
        <initialValue>installed</initialValue>
        <change>
          <condition label="Sample Sourcetypes">
            <set token="addsample">| append [
        | inputlookup Sample_sourcetypes.csv
        | eval tag_name=split(tag_name,",")
        | fields Sourcetype tag_name app_sourcetype app
        | stats values(tag_name) as tag_name by app, Sourcetype,app_sourcetype
        | rename Sourcetype AS sourcetype
            ]</set>
            <set token="replacewithsample">| eval sourcetype_origin=sourcetype_origin_sample
              | eval AddOn=AddOn_sample</set>
          </condition>
          <condition label="*">
            <set token="addsample"></set>
            <set token="replacewithsample"></set>
          </condition>
        </change>
      </input>
      <input type="multiselect" token="sourcetype_selection">
        <label>Sourcetype selection</label>
        <fieldForLabel>Sourcetype</fieldForLabel>
        <fieldForValue>Sourcetype</fieldForValue>
        <search base="usecase_base">
          <query>| stats count by Sourcetype | fields Sourcetype | sort 0 Sourcetype</query>
        </search>
        <choice value="*">None</choice>
        <default>*</default>
        <valuePrefix>"</valuePrefix>
        <delimiter>,</delimiter>
        <valueSuffix>"</valueSuffix>
      </input>
      <chart>
        <search base="usecase_base">
          <query>
            | eval Status=if("$x_field$"!="AddOn" AND in(Sourcetype,$sourcetype_selection$), "Selected",Status)
               | foreach Enabled Hosts Sourcetype AddOn Datamodel Status "Use Case Orig" [
             | eval "&lt;&lt;FIELD&gt;&gt;"=coalesce('&lt;&lt;FIELD&gt;&gt;',"-")
            ]
            | search sourcetype_origin="$sourcetype_origin$" Status="$phase$"
| chart count over "$x_field$" By "$y_field$"
| eval Selected_New=case(isnotnull(Sourcetype) AND in(Sourcetype,$sourcetype_selection$), Selected,isnotnull(Sourcetype) AND NOT in(Sourcetype,$sourcetype_selection$),0,1=1,Selected)
| eval m="Move the overlapping entries to Phase 2 so they dont get lost while filtering"
| fields - m
| eval "Phase 2 - Needs more data"=if(Selected_New=0 AND Selected&gt;0, 'Phase 2 - Needs more data'+Selected, 'Phase 2 - Needs more data')
| rename Selected_New AS Selected
              $chart_post_process$</query>
        </search>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">-45</option>
        <option name="charting.axisLabelsY.majorUnit">1</option>
        <option name="charting.axisTitleY.text">Content</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisY.abbreviation">none</option>
        <option name="charting.chart">column</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.fieldColors">{"Current": 0x638771, "Phase 1 - Potential": 0xA0BBAA, "Phase 2 - Needs more data":0xE0E9E3, "Yes":0x638771, "No":0xE0E9E3, "Enabled":0x638771, "Disabled":0xE0E9E3,"Selected":0xEC9960}</option>
        <option name="height">310</option>
        <option name="refresh.display">progressbar</option>
        <drilldown>
          <eval token="form.corr_enabled">if($form.y_field$="Enabled" OR $form.y_field$="Enabled and Accelerated", $click.name2$,"*")</eval>
          <eval token="form.accelerated">if($form.y_field$="Accelerated" OR $form.y_field$="Enabled and Accelerated", $click.name2$,"*")</eval>
          <eval token="form.status">$click.name2$</eval>
          <eval token="form.phase">$click.name2$</eval>
          <eval token="form.sourcetype">if($form.x_field$="Sourcetype", $click.value$,"*")</eval>
          <eval token="form.datamodel">if($form.x_field$="Datamodel", $click.value$,"*")</eval>
          <eval token="form.AddOn">if($form.x_field$="AddOn", $click.value$,"*")</eval>
          <eval token="form.App">if($form.x_field$="App", $click.value$,"*")</eval>
          <eval token="form.kill_chain_phase">if($form.x_field$="Kill Chain Phase", $click.value$,"*")</eval>
        </drilldown>
      </chart>
    </panel>
  </row>
  <row id="row2_col1">
    <panel depends="$radar$">
      <input type="dropdown" token="phase">
        <label>Phase</label>
        <choice value="*">Any</choice>
        <choice value="Current">Current</choice>
        <choice value="Phase 1 - Potential">Phase 1</choice>
        <choice value="Phase 2 - Needs more data">Phase 2</choice>
        <default>*</default>
      </input>
      <input type="dropdown" token="sourcetype_origin">
        <label>Sourcetypes</label>
        <choice value="installed">Installed Sourcetypes</choice>
        <choice value="sample">Sample Sourcetypes</choice>
        <choice value="*">All Sourcetypes</choice>
        <default>installed</default>
        <initialValue>installed</initialValue>
        <change>
          <condition label="Sample Sourcetypes">
            <set token="addsample">| append [
        | inputlookup Sample_sourcetypes.csv
        | eval tag_name=split(tag_name,",")
        | fields Sourcetype tag_name app_sourcetype app
        | stats values(tag_name) as tag_name by app, Sourcetype,app_sourcetype
        | rename Sourcetype AS sourcetype
            ]</set>
            <set token="replacewithsample">| eval sourcetype_origin=sourcetype_origin_sample
              | eval AddOn=AddOn_sample</set>
          </condition>
          <condition label="*">
            <set token="addsample"></set>
            <set token="replacewithsample"></set>
          </condition>
        </change>
      </input>
      <viz type="custom-radar-chart-viz.radar_chart">
        <title>(Requires Radar Viz)</title>
        <search base="usecase_base">
          <query>| eval Status=if("$x_field$"!="AddOn" AND in(Sourcetype,$sourcetype_selection$), "Selected",Status)
| search sourcetype_origin="$sourcetype_origin$" Status="$phase$"
| chart count over "$x_field$" By Status

| eval Selected_New=case(isnotnull(Sourcetype) AND in(Sourcetype,$sourcetype_selection$), Selected,isnotnull(Sourcetype) AND NOT in(Sourcetype,$sourcetype_selection$),0,1=1,Selected)
| eval m="Move the overlapping entries to Phase 2 so they dont get lost while filtering"
| fields - m
| eval "Phase 2 - Needs more data"=if(Selected_New=0 AND Selected&gt;0, 'Phase 2 - Needs more data'+Selected, 'Phase 2 - Needs more data')
| rename Selected_New AS Selected

| append
[
| inputlookup kill_chain_phases.csv
| fields title order_title
| rename order_title AS "Kill Chain Phase"
]
| stats first(*) AS * BY "Kill Chain Phase"
| fields - "Kill Chain Phase"
| rename title AS "Kill Chain Phase"
| fillnull
|  foreach "Current" "Phase 1 - Potential" "Phase 2 - Needs more data" Selected
[
    | eval "&amp;lt;&amp;lt;FIELD&amp;gt;&amp;gt;"=if(isnull('&amp;lt;&amp;lt;FIELD&amp;gt;&amp;gt;'), 0,'&amp;lt;&amp;lt;FIELD&amp;gt;&amp;gt;' )
]
| table "$x_field$" "Current" "Phase 1 - Potential" "Phase 2 - Needs more data" Selected

| untable "$x_field$" key value
| rename  "$x_field$" AS axis
| eval keyColor=case(
key="Current","#638771",
key="Phase 1 - Potential","#A0BBAA",
key="Phase 2 - Needs more data","#E0E9E3",
key="Selected","#EC9960"
)</query>
        </search>
        <option name="custom-radar-chart-viz.radar_chart.areasOpacity">0.35</option>
        <option name="custom-radar-chart-viz.radar_chart.axesLabelFontColor">#737373</option>
        <option name="custom-radar-chart-viz.radar_chart.axesLegendFontColor">#000000</option>
        <option name="custom-radar-chart-viz.radar_chart.axesLineColor">#FFFFFF</option>
        <option name="custom-radar-chart-viz.radar_chart.chartHeight">500</option>
        <option name="custom-radar-chart-viz.radar_chart.chartWidth">500</option>
        <option name="custom-radar-chart-viz.radar_chart.circlesColor">#CDCDCD</option>
        <option name="custom-radar-chart-viz.radar_chart.circlesFillColor">#ffffff</option>
        <option name="custom-radar-chart-viz.radar_chart.circlesOpacity">0.1</option>
        <option name="custom-radar-chart-viz.radar_chart.fullScreen">0</option>
        <option name="custom-radar-chart-viz.radar_chart.isRounded">0</option>
        <option name="custom-radar-chart-viz.radar_chart.legendEnabled">1</option>
        <option name="custom-radar-chart-viz.radar_chart.legendFontColor">#000000</option>
        <option name="custom-radar-chart-viz.radar_chart.legendPositionX">25</option>
        <option name="custom-radar-chart-viz.radar_chart.legendPositionY">25</option>
        <option name="custom-radar-chart-viz.radar_chart.legendSymbol">cross</option>
        <option name="custom-radar-chart-viz.radar_chart.legendToggleSymbol">circle</option>
        <option name="custom-radar-chart-viz.radar_chart.levels">10</option>
        <option name="custom-radar-chart-viz.radar_chart.maxValue">90</option>
        <option name="drilldown">none</option>
        <option name="height">466</option>
        <option name="refresh.display">progressbar</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </viz>
    </panel>
  </row>
  <row id="row3_col1">
    <panel depends="$sankey$">
      <title>Content from Add-On &gt; Data Model &gt; Sourcetype &gt; $y_field$</title>
      <input type="dropdown" token="phase">
        <label>Phase</label>
        <choice value="*">Any</choice>
        <choice value="Current">Current</choice>
        <choice value="Phase 1 - Potential">Phase 1</choice>
        <choice value="Phase 2 - Needs more data">Phase 2</choice>
        <default>*</default>
      </input>
      <input type="dropdown" token="sourcetype_origin">
        <label>Sourcetypes</label>
        <choice value="installed">Installed Sourcetypes</choice>
        <choice value="*">All Sourcetypes</choice>
        <default>installed</default>
        <initialValue>installed</initialValue>
        <change>
          <condition label="Sample Sourcetypes">
            <set token="addsample">| append [
        | inputlookup Sample_sourcetypes.csv
        | eval tag_name=split(tag_name,",")
        | fields Sourcetype tag_name app_sourcetype app
        | stats values(tag_name) as tag_name by app, Sourcetype,app_sourcetype
        | rename Sourcetype AS sourcetype
            ]</set>
            <set token="replacewithsample">| eval sourcetype_origin=sourcetype_origin_sample
              | eval AddOn=AddOn_sample</set>
          </condition>
          <condition label="*">
            <set token="addsample"></set>
            <set token="replacewithsample"></set>
          </condition>
        </change>
      </input>
      <viz type="sankey_diagram_app.sankey_diagram">
        <title>(Requires Sankey Viz)</title>
        <search base="usecase_base">
          <query>| search sourcetype_origin="$sourcetype_origin$"  Status="$phase$"
            | appendpipe [| stats count(eval('$y_field$'="Yes")) AS "$y_field$_l1", count AS l1 by Sourcetype AddOn]
| appendpipe [| stats count(eval('$y_field$'="Yes")) AS "$y_field$_l2", count AS l2 by AddOn Datamodel]
| appendpipe [| stats count(eval('$y_field$'="Yes")) AS "$y_field$_l3", count AS l3 by Datamodel "$y_field$"]
| table Description Sourcetype AddOn Datamodel "$y_field$" l1 l2 l3 "$y_field$_l1" "$y_field$_l2" "$y_field$_l3"
| eval LinkSource=case(isnotnull(l1), Sourcetype, isnotnull(l2), AddOn, isnotnull(l3), Datamodel, 1=1,null) 
| eval LinkDestination=case(isnotnull(l1), AddOn, isnotnull(l2), Datamodel, isnotnull(l3), '$y_field$', 1=1,null)
| eval count=coalesce(l1,l2,l3)
| where isnotnull(l1) OR isnotnull(l2) OR isnotnull(l3)
| table LinkSource LinkDestination count</query>
        </search>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <option name="sankey_diagram_app.sankey_diagram.colorMode">sequential</option>
        <option name="sankey_diagram_app.sankey_diagram.maxColor">#638771</option>
        <option name="sankey_diagram_app.sankey_diagram.minColor">#F5F8F6</option>
        <option name="sankey_diagram_app.sankey_diagram.numOfBins">9</option>
        <option name="sankey_diagram_app.sankey_diagram.showLegend">true</option>
        <option name="sankey_diagram_app.sankey_diagram.useColors">true</option>
        <option name="trellis.enabled">0</option>
        <option name="trellis.scales.shared">1</option>
        <option name="trellis.size">medium</option>
      </viz>
    </panel>
  </row>
  <row id="cs3">
    <panel>
      <title>Content configured in the system</title>
      <input type="dropdown" token="phase">
        <label>Phase</label>
        <choice value="*">Any</choice>
        <choice value="Current">Current</choice>
        <choice value="Phase 1 - Potential">Phase 1 - Potential</choice>
        <choice value="Phase 2 - Needs more data">Phase 2 - Needs more data</choice>
        <default>*</default>
      </input>
      <input type="dropdown" token="corr_data">
        <label>Data</label>
        <choice value="=*">Any</choice>
        <choice value="&gt;0">Yes</choice>
        <choice value="=0">No</choice>
        <default>=*</default>
      </input>
      <input type="dropdown" token="corr_enabled">
        <label>Enabled</label>
        <choice value="*">Any</choice>
        <choice value="Yes">Yes</choice>
        <choice value="No">No</choice>
        <default>*</default>
      </input>
      <input type="dropdown" token="datamodel">
        <label>Datamodel</label>
        <fieldForLabel>Datamodel</fieldForLabel>
        <fieldForValue>Datamodel</fieldForValue>
        <search base="usecase_base">
          <query>| stats count by Datamodel | fields Datamodel | sort 0 Datamodel</query>
        </search>
        <choice value="*">Any</choice>
        <default>*</default>
      </input>
      <input type="multiselect" token="sourcetype">
        <label>Sourcetype</label>
        <fieldForLabel>Sourcetype</fieldForLabel>
        <fieldForValue>Sourcetype</fieldForValue>
        <search base="usecase_base">
          <query>| stats count by Sourcetype | fields Sourcetype | sort 0 Sourcetype</query>
        </search>
        <choice value="*">Any</choice>
        <default>*</default>
        <valuePrefix>Sourcetype="</valuePrefix>
        <delimiter> OR </delimiter>
        <valueSuffix>"</valueSuffix>
      </input>
      <input type="dropdown" token="AddOn">
        <label>Add-On</label>
        <fieldForLabel>AddOn</fieldForLabel>
        <fieldForValue>AddOn</fieldForValue>
        <search base="usecase_base">
          <query>| stats count by AddOn | fields AddOn | sort 0 AddOn</query>
        </search>
        <choice value="*">Any</choice>
        <default>*</default>
      </input>
      <input type="dropdown" token="kill_chain_phase">
        <label>Kill Chain Phase</label>
        <fieldForLabel>Kill Chain Phase</fieldForLabel>
        <fieldForValue>Kill Chain Phase</fieldForValue>
        <search base="usecase_base">
          <query>| stats count by "Kill Chain Phase"
| fields "Kill Chain Phase"
| sort 0 "Kill Chain Phase"
| eval "Kill Chain Phase"=substr('Kill Chain Phase',3,100)</query>
        </search>
        <choice value="*">Any</choice>
        <default>*</default>
      </input>
      <input type="checkbox" token="show_sourcetype">
        <label>Sourcetype and Add-On</label>
        <choice value="Sourcetype AddOn">Show</choice>
        <change>
          <eval token="show_sourcetype_table">if(isnull($form.show_sourcetype$) OR $form.show_sourcetype$="", " ",$form.show_sourcetype$)</eval>
        </change>
      </input>
      <input type="checkbox" token="show_search">
        <label>Search Query</label>
        <choice value="&quot;Detection Search&quot;">Show</choice>
        <change>
          <eval token="show_search_table">if(isnull($form.show_search$) OR $form.show_search$="", " ",$form.show_search$)</eval>
        </change>
      </input>
      <input type="text" token="searchfilter">
        <label>Search Filter</label>
        <default></default>
      </input>
    </panel>
  </row>
  <row id="tabs_content_table">
    <panel>
      <html>
      <h1>Content Overview - Click to filter</h1>
      <ul id="tabs" class="nav nav-tabs">
                    <li class="active">
                        <a href="#" class="toggle-tab" data-toggle="tab" data-elements="row4_col1,row1_col1" data-token="row4_col1">Content View</a>
                    </li>
                    <li>
                        <a href="#" class="toggle-tab" data-toggle="tab" data-elements="row5_col1,row1_col1" data-token="row5_col1">Sourcetype View</a>
                    </li>
				</ul>


    </html>
    </panel>
  </row>
  <row id="row4_col1">
    <panel>
      <table id="content_table">
        <search base="usecase_base">
          <query>
            | eval Status=if(in(Sourcetype,$sourcetype_selection$), "Selected",Status)
            | search Enabled="$corr_enabled$" Hosts$corr_data$ ($sourcetype$) AddOn=$AddOn$ Datamodel="$datamodel$" Status="$phase$" "Kill Chain Phase Orig"="$kill_chain_phase$"
            | where like(lower(Title),"%".lower("$searchfilter$")."%") OR like(lower(Description),"%".lower("$searchfilter$")."%") OR like(lower('Detection Search'),"%".lower("$searchfilter$")."%")

              | eval sourcetypes_selected=mvfilter($sourcetype$)
            | eval Sourcetype=coalesce(sourcetypes_selected,Sourcetype)
            | fields - Tags
            | lookup Installed_sourcetypes.csv Sourcetype OUTPUT sourcetype_count_24h
            | rename Events AS "Events (DM)", sourcetype_count_24h AS "Events (Sourcetype)"
            | table Status "Title", Description, Details,$show_search_table$,"Kill Chain Phase",App,Datamodel, $show_sourcetype_table$,deeplink
</query>
        </search>
        <option name="count">5</option>
        <option name="drilldown">cell</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">true</option>
        <option name="totalsRow">true</option>
        <format type="color" field="Status">
          <colorPalette type="map">{"Current":#638771,"Phase 1 - Potential":#A0BBAA,"Phase 2 - Needs more data":#E0E9E3,"Selected":0xEC9960}</colorPalette>
        </format>
        <format type="number" field="Events">
          <option name="precision">0</option>
        </format>
        <format type="color" field="Events">
          <colorPalette type="list">[#E0E9E3,#638771]</colorPalette>
          <scale type="threshold">1</scale>
        </format>
        <format type="color" field="Hosts">
          <colorPalette type="list">[#E0E9E3,#638771]</colorPalette>
          <scale type="threshold">1</scale>
        </format>
        <format type="color" field="Enabled">
          <colorPalette type="map">{"Yes":#638771,"No":#E0E9E3}</colorPalette>
        </format>
        <format type="color" field="Accelerated">
          <colorPalette type="map">{"Yes":#638771,"No":#E0E9E3}</colorPalette>
        </format>
        <drilldown>
          <link target="_blank">
            <![CDATA[
        /app/$row.deeplink|n$
         ]]>
          </link>
        </drilldown>
      </table>
    </panel>
  </row>
  <row id="row5_col1">
    <panel>
      <table id="sourcetype_table">
        <search base="usecase_base">
          <query>| eval Status=if(in(Sourcetype,$sourcetype_selection$), "Selected",Status)
| search Enabled="$corr_enabled$" Hosts$corr_data$ AddOn=$AddOn$ Datamodel="$datamodel$" Status="$phase$" "Kill Chain Phase Orig"="$kill_chain_phase$"
| mvexpand Sourcetype
| where Sourcetype!="-"
| stats
sum(eval(if(Status="Current",1,0))) AS Current,
sum(eval(if(Status="Phase 1 - Potential",1,0))) AS "Phase 1 - Potential",
sum(eval(if(Status="Phase 2 - Needs more data",1,0))) AS "Phase 2 - Needs more data",
sum(eval(if(Status="Selected",1,0))) AS "Selected"
BY Sourcetype

| eval Selected_New=case(isnotnull(Sourcetype) AND in(Sourcetype,$sourcetype_selection$), Selected,isnotnull(Sourcetype) AND NOT in(Sourcetype,$sourcetype_selection$),0,1=1,Selected)
| eval m="Move the overlapping entries to Phase 2 so they dont get lost while filtering"
| fields - m
| eval "Phase 2 - Needs more data"=if(Selected_New=0 AND Selected&gt;0, 'Phase 2 - Needs more data'+Selected, 'Phase 2 - Needs more data')
| rename Selected_New AS Selected

| lookup Installed_sourcetypes.csv Sourcetype OUTPUT sourcetype_count_24h AS "Events (-24h)", host_count_24h AS "Hosts (-24h)", app AS "Add-On"
| lookup SourcetypeNormalisation Sourcetype OUTPUT Normalised
| eval Sourcetype=mvdedup(coalesce(Normalised,Sourcetype))
| eval Total='Current'+'Phase 1 - Potential'+'Phase 2 - Needs more data'+'Selected'
| sort - Total
| table "Sourcetype" Total "Current" "Phase 1 - Potential" "Phase 2 - Needs more data" Selected "Add-On" "Events (-24h)" "Hosts (-24h)"</query>
        </search>
        <option name="count">10</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">true</option>
        <option name="totalsRow">true</option>
        <format type="color" field="Total">
          <colorPalette type="minMidMax" maxColor="#638771" minColor="#FFFFFF"></colorPalette>
          <scale type="minMidMax"></scale>
        </format>
        <format type="color" field="Current">
          <colorPalette type="list">[#638771]</colorPalette>
          <scale type="threshold"></scale>
        </format>
        <format type="color" field="Phase 1 - Potential">
          <colorPalette type="minMidMax" maxColor="#A0BBAA" minColor="#FFFFFF"></colorPalette>
          <scale type="minMidMax"></scale>
        </format>
        <format type="color" field="Phase 2 - Needs more data">
          <colorPalette type="minMidMax" maxColor="#E0E9E3" minColor="#FFFFFF"></colorPalette>
          <scale type="minMidMax"></scale>
        </format>
        <format type="color" field="Selected">
          <colorPalette type="minMidMax" maxColor="#EC9960" minColor="#FFFFFF"></colorPalette>
          <scale type="minMidMax"></scale>
        </format>
        <drilldown>
          <set token="form.sourcetype">$row.Sourcetype$</set>
        </drilldown>
      </table>
    </panel>
  </row>
</form>